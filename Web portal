<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TicTracker</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  :root{--primary:#2a5d67;--primary-2:#387b86;--bg:#e2f6f2;--text:#333;--light:#fff}
  *{box-sizing:border-box;font-family:'Poppins',sans-serif;margin:0;padding:0}
  body{min-height:100vh;background:linear-gradient(135deg,#cde8e5,var(--bg));color:var(--text);display:flex}
  .sidebar{width:260px;background:var(--primary);color:#fff;position:fixed;inset:0 auto 0 0;padding:20px 0;overflow-y:auto}
  .logo{font-weight:700;font-size:1.6rem;text-align:center;margin-bottom:18px}
  .switch-wrap{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.08);margin:0 16px 16px;border-radius:12px;padding:10px 12px}
  .switch{position:relative;width:54px;height:30px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;inset:0;background:#b7c8c9;border-radius:9999px;cursor:pointer;transition:.2s}
  .slider:before{content:"";position:absolute;height:22px;width:22px;left:4px;top:4px;background:#fff;border-radius:50%;transition:.2s}
  input:checked + .slider{background:#0e3d45}
  input:checked + .slider:before{transform:translateX(24px)}
  .nav-link{display:flex;align-items:center;gap:10px;color:#dfeef0;text-decoration:none;padding:12px 18px;transition:.15s}
  .nav-link:hover,.nav-link.active{background:rgba(0,0,0,.18);color:#fff}
  .bottom{position:sticky;bottom:0;margin-top:20px;padding-top:10px}
  .main{margin-left:260px;padding:28px;flex:1}
  .header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:22px}
  .welcome{color:var(--primary);font-size:1.8rem;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:22px}
  .card{background:#fff;border-radius:16px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .card h3{color:var(--primary);margin-bottom:10px}
  .metric{font-size:2.4rem;font-weight:800}
  .btn{border:0;border-radius:10px;background:var(--primary);color:#fff;padding:10px 16px;cursor:pointer}
  .btn.secondary{background:#ccc;color:#222}
  .btn.link{background:transparent;color:var(--primary);padding:0}
  label{font-weight:600;margin-bottom:6px;display:block}
  input,select,textarea{width:100%;border:1px solid #ddd;border-radius:10px;padding:10px}
  textarea{min-height:90px;resize:vertical}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
  .tic-type{display:flex;gap:10px}
  .chip{flex:1;text-align:center;border:2px solid var(--primary);border-radius:10px;padding:10px;font-weight:600;color:var(--primary);cursor:pointer}
  .chip.active{background:var(--primary);color:#fff}
  #toast{position:fixed;right:20px;bottom:20px;background:#fff;border-left:6px solid var(--primary);padding:12px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.12);display:none;max-width:320px}
  #auth-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
  #auth-box{background:#fff;width:min(360px,92vw);padding:22px;border-radius:14px;box-shadow:0 12px 32px rgba(0,0,0,.25)}
  #auth-box h3{color:var(--primary);margin-bottom:8px}
  #auth-error{min-height:20px;font-size:.9rem;margin:6px 0}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  .table td.actions{width:80px}
  .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  @media(max-width:820px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.main{margin-left:0}}
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="logo">TicTracker</div>

  <div class="switch-wrap">
    <span>Professional Mode</span>
    <label class="switch">
      <input id="modeSwitch" type="checkbox">
      <span class="slider"></span>
    </label>
  </div>

  <!-- Patient nav -->
  <nav id="nav-patient">
    <a href="#" class="nav-link active" data-target="dash-patient"><i class="fas fa-th-large"></i> Dashboard Overview</a>
    <a href="#" class="nav-link" data-target="log"><i class="fas fa-edit"></i> New Tic Log Entry</a>
    <a href="#" class="nav-link" data-target="diary"><i class="fas fa-book"></i> Emotional Diary</a>
    <a href="#" class="nav-link" data-target="meds"><i class="fas fa-pills"></i> Medication Tracker</a>
    <a href="#" class="nav-link" data-target="resources"><i class="fas fa-compass"></i> Resource Hub</a>
    <a href="#" class="nav-link" data-target="profile"><i class="fas fa-user-cog"></i> Profile & Contacts</a>
  </nav>

  <!-- Professional nav -->
  <nav id="nav-pro" style="display:none;">
    <a href="#" class="nav-link active" data-target="pro-patients"><i class="fas fa-users"></i> Patient Access</a>
    <a href="#" class="nav-link" data-target="pro-reports"><i class="fas fa-file-alt"></i> Clinical Reports</a>
    <a href="#" class="nav-link" data-target="pro-library"><i class="fas fa-briefcase-medical"></i> Documentation Library</a>
    <a href="#" class="nav-link" data-target="pro-settings"><i class="fas fa-cogs"></i> Practice Settings</a>
  </nav>

  <div class="bottom">
    <!-- keep class for styling; routing will ignore it -->
    <a href="#" class="nav-link" id="logout"><i class="fas fa-sign-out-alt"></i> Log Out</a>
  </div>
</aside>

<!-- Main -->
<main class="main">
  <div class="header">
    <div class="welcome" id="welcome">Welcome!</div>
    <button class="btn" id="toggleSidebarBtn"><i class="fas fa-bars"></i></button>
  </div>

  <!-- Patient Dashboard -->
  <section id="dash-patient" class="page">
    <div class="grid">
      <div class="card">
        <h3>Tics Logged Today</h3>
        <div class="metric" id="metric-today">0</div>
        <div id="metric-today-sub">No entries yet.</div>
      </div>

      <div class="card">
        <h3>Mood Today</h3>
        <div class="metric" id="metric-mood">â€”</div>
        <div id="metric-mood-sub">Log a diary entry to update.</div>
      </div>

      <div class="card">
        <h3>Medication Adherence (7d)</h3>
        <div class="metric" id="metric-adherence">â€”</div>
        <div id="metric-adherence-sub">Log doses to see adherence.</div>
      </div>

      <div class="card" style="grid-column:1/-1;background:#0f3f45;color:#eaf5f6;">
        <h3>âš¡ Quick Tic Log</h3>
        <p>Tap to instantly record a tic occurrence.</p>
        <button class="btn" id="quickTic">Mark Tic Occurrence</button>
      </div>
    </div>
  </section>

  <!-- Detailed Tic Log + LIST + Delete -->
  <section id="log" class="page" style="display:none;">
    <div class="card">
      <h3>Detailed Tic Log</h3>
      <div class="row" style="margin:10px 0">
        <div>
          <label>Tic Type</label>
          <div class="tic-type">
            <div class="chip active" data-type="motor">Motor</div>
            <div class="chip" data-type="vocal">Vocal</div>
          </div>
        </div>
        <div>
          <label>Start Time</label>
          <input type="time" id="tic-time">
        </div>
        <div>
          <label>Duration (seconds)</label>
          <input type="number" id="tic-duration" min="0" value="0">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Intensity (1â€“10)</label>
          <input type="range" id="tic-intensity" min="1" max="10" value="5" oninput="document.getElementById('int-val').textContent=this.value">
          <div>Current: <b id="int-val">5</b></div>
        </div>
        <div>
          <label>Added By</label>
          <select id="tic-added"><option value="self">Self</option><option value="caregiver">Caregiver</option></select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Description / Notes</label>
        <textarea id="tic-desc" placeholder="e.g., eye blinking (simple motor)"></textarea>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button class="btn secondary" id="cancel-log">Cancel</button>
        <button class="btn" id="save-log">Save Log</button>
      </div>
    </div>

    <div class="card" id="tics-list" style="margin-top:16px;">
      <div class="toolbar">
        <h3 style="margin-right:auto">Your Tic Logs</h3>
        <label>Filter:
          <select id="tics-filter">
            <option value="all">All</option>
            <option value="today">Today</option>
          </select>
        </label>
      </div>
      <table class="table" id="tics-table">
        <thead>
          <tr><th>When</th><th>Type</th><th>Intensity</th><th>Duration (s)</th><th>Description</th><th>Added By</th><th class="actions">Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="display:flex;justify-content:flex-end;margin-top:10px;">
        <button class="btn secondary" id="tics-load">Load more</button>
      </div>
    </div>
  </section>

  <!-- Emotional Diary -->
  <section id="diary" class="page" style="display:none;">
    <div class="card">
      <h3>Emotional Diary (Daily)</h3>
      <div class="row">
        <div><label>Mood</label><select id="diary-mood"><option>Great</option><option>Good</option><option>OK</option><option>Low</option><option>Bad</option></select></div>
        <div><label>Stress (1â€“10)</label><input type="number" id="diary-stress" min="1" max="10" value="5"></div>
        <div><label>Sleep (hours)</label><input type="number" id="diary-sleep" min="0" max="24" value="8"></div>
      </div>
      <div style="margin-top:10px">
        <label>Notes</label><textarea id="diary-notes" placeholder="Anything notable today..."></textarea>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="save-diary">Save Diary</button>
      </div>
    </div>
  </section>

  <!-- Medication Tracker -->
  <section id="meds" class="page" style="display:none;">
    <div class="card">
      <h3>Medication Log</h3>
      <div class="row">
        <div><label>Medication Name</label><input id="med-name" placeholder="e.g., Clonidine"></div>
        <div><label>When</label><input type="time" id="med-time"></div>
        <div><label>Status</label><select id="med-status"><option value="taken">Taken</option><option value="missed">Missed</option></select></div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="save-med">Log Dose</button>
      </div>
    </div>

    <div class="card" id="meds-list" style="margin-top:16px;">
      <h3>Recent Doses</h3>
      <table class="table" id="meds-table"><thead><tr><th>When</th><th>Medication</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- Resources -->
  <section id="resources" class="page" style="display:none;">
    <div class="card">
      <h3>Resource Hub</h3>
      <p>Add helpful links or notes for coping strategies (saved per user).</p>
      <div class="row">
        <div><label>Title</label><input id="res-title" placeholder="Progressive Muscle Relaxation"/></div>
        <div><label>URL (optional)</label><input id="res-url" placeholder="https://..."/></div>
      </div>
      <div style="margin-top:10px">
        <label>Notes</label><textarea id="res-notes"></textarea>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="save-res">Save Resource</button>
      </div>
    </div>
  </section>

  <!-- Profile -->
  <section id="profile" class="page" style="display:none;">
    <div class="card">
      <h3>Profile</h3>
      <div class="row">
        <div><label>Display Name</label><input id="prof-name" placeholder="Your name"/></div>
        <div><label>Role</label>
          <select id="prof-role">
            <option value="patient">Patient / Caregiver</option>
            <option value="professional">Professional</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="save-profile">Save Profile</button>
      </div>
    </div>
  </section>

  <!-- Professional: Patient Access -->
  <section id="pro-patients" class="page" style="display:none;">
    <div class="card">
      <h3>Professional Patient Management</h3>
      <p><b>Overview:</b> Access secure patient profiles and treatment data.</p>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="card">
        <h3>Active Patients</h3>
        <div class="metric" id="pro-active">0</div>
        <div>Count of registered patients.</div>
      </div>
      <div class="card">
        <h3>Average Adherence (7d)</h3>
        <div class="metric" id="pro-adherence">â€”</div>
        <div>Across all patients with logs.</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3>Patients</h3>
      <table class="table" id="pro-table"><thead><tr><th>Name / Email</th><th>Todayâ€™s Tics</th><th>Adherence (7d)</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="pro-reports" class="page" style="display:none;"><div class="card"><h3>Clinical Reports</h3><p>Coming soon.</p></div></section>
  <section id="pro-library" class="page" style="display:none;"><div class="card"><h3>Documentation Library</h3><p>Coming soon.</p></div></section>
  <section id="pro-settings" class="page" style="display:none;"><div class="card"><h3>Practice Settings</h3><p>Coming soon.</p></div></section>
</main>

<!-- Toast -->
<div id="toast"></div>

<!-- Auth Modal -->
<div id="auth-modal">
  <div id="auth-box">
    <h3>TicTracker Login</h3>
    <input id="auth-email" type="email" placeholder="Email"/>
    <input id="auth-pass" type="password" placeholder="Password"/>
    <div id="auth-error" style="color:#b00020;"></div>
    <div style="display:flex;gap:8px;margin-top:6px">
      <button class="btn" id="btn-signin">Sign In</button>
      <button class="btn secondary" id="btn-signup">Sign Up</button>
    </div>
    <div style="text-align:right;margin-top:8px"><a href="#" id="btn-reset">Forgot password?</a></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword,
    createUserWithEmailAndPassword, sendPasswordResetEmail, signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where,
    serverTimestamp, Timestamp, orderBy, limit, startAfter, deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // ðŸ”§ Replace if your console shows different values
  const firebaseConfig = {
    apiKey: "AIzaSyDtbp9D6yItSLy5HY_YJAWs9esDRBNm-NE",
    authDomain: "tick-tracker-1d0ce.firebaseapp.com",
    projectId: "tick-tracker-1d0ce",
    storageBucket: "tick-tracker-1d0ce.appspot.com",
    messagingSenderId: "990717715012",
    appId: "1:990717715012:web:fff2fcb9a66a3f4d1ed211"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];
  const toast = (msg) => { const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",3000); };

  // Elements
  const sidebar = $("#sidebar");
  $("#toggleSidebarBtn").onclick = () => sidebar.classList.toggle("open");
  const modeSwitch = $("#modeSwitch");
  const navPatient = $("#nav-patient");
  const navPro = $("#nav-pro");
  const welcome = $("#welcome");
  const modal = $("#auth-modal");
  const em = $("#auth-email"), pw = $("#auth-pass"), err = $("#auth-error");

  // Auth actions
  $("#btn-signin").onclick = async ()=> {
    try{ await signInWithEmailAndPassword(auth, em.value.trim(), pw.value); }
    catch(e){ err.textContent = mapAuth(e); }
  };
  $("#btn-signup").onclick = async ()=> {
    try{
      const cred = await createUserWithEmailAndPassword(auth, em.value.trim(), pw.value);
      await setDoc(doc(db,"users",cred.user.uid),{
        email: cred.user.email, role: "patient", name: "", created: serverTimestamp()
      });
    }catch(e){ err.textContent = mapAuth(e); }
  };
  $("#btn-reset").onclick = async (e)=> {
    e.preventDefault();
    try{ await sendPasswordResetEmail(auth, em.value.trim()); err.style.color="#2a5d67"; err.textContent="Password reset email sent."; }
    catch(e2){ err.style.color="#b00020"; err.textContent = mapAuth(e2); }
  };

  // âœ… Logout: stop router + sign out
  $("#logout").addEventListener("click", async (e)=>{
    e.preventDefault();
    e.stopPropagation();
    try { await signOut(auth); toast("Signed out"); }
    catch (err) { toast("Sign out failed: " + (err?.message || "")); }
  });

  // Navigation â€” bind ONLY links with data-target (avoids hijacking logout)
  $$(".nav-link[data-target]").forEach(a=>{
    a.onclick = (ev)=>{
      ev.preventDefault();
      $$(".nav-link").forEach(x=>x.classList.remove("active"));
      a.classList.add("active");
      $$(".page").forEach(p=>p.style.display="none");
      const id = "#"+a.dataset.target;
      const el = $(id); if(el){ el.style.display="block"; }
      if(id==="#dash-patient") refreshPatientMetrics();
      if(id==="#meds") loadRecentMeds();
      if(id==="#log") { resetTicList(); loadTicPage(); }
      if(id==="#pro-patients") loadProView();
      sidebar.classList.remove("open");
    };
  });

  // Chip toggle
  $$(".chip").forEach(c=> c.onclick = ()=>{
    $$(".chip").forEach(x=>x.classList.remove("active"));
    c.classList.add("active");
  });

  // Default times
  window.onload = ()=> {
    const t=$("#tic-time"); if(t) t.value = new Date().toTimeString().slice(0,5);
    const mt=$("#med-time"); if(mt) mt.value = new Date().toTimeString().slice(0,5);
  };

  // Patient actions
  $("#quickTic").onclick = async ()=>{
    if(!auth.currentUser) return;
    await addDoc(collection(db,"ticLogs"),{
      uid: auth.currentUser.uid, type: "quick", intensity: 0, duration: 0, addedBy: "self",
      desc: "Quick tic", created: serverTimestamp()
    });
    toast("Quick tic logged");
    refreshPatientMetrics();
    if($("#log").style.display==="block"){ resetTicList(); loadTicPage(); }
  };

  $("#cancel-log").onclick = ()=>{ $("#tic-desc").value=""; };

  $("#save-log").onclick = async ()=>{
    if(!auth.currentUser) return;
    const type = $(".chip.active").dataset.type;
    const time = $("#tic-time").value;
    const duration = Number($("#tic-duration").value||0);
    const intensity = Number($("#tic-intensity").value||5);
    const desc = $("#tic-desc").value.trim();
    const addedBy = $("#tic-added").value;
    if(!time || !desc){ toast("Please fill time and description"); return; }
    await addDoc(collection(db,"ticLogs"),{
      uid: auth.currentUser.uid, type, time, duration, intensity, desc, addedBy, created: serverTimestamp()
    });
    toast("Detailed Tic Log Saved");
    $("#tic-desc").value="";
    refreshPatientMetrics();
    resetTicList(); loadTicPage();
  };

  $("#save-diary").onclick = async ()=>{
    if(!auth.currentUser) return;
    await addDoc(collection(db,"diary"),{
      uid: auth.currentUser.uid, mood: $("#diary-mood").value, stress: Number($("#diary-stress").value),
      sleep: Number($("#diary-sleep").value), notes: $("#diary-notes").value.trim(), created: serverTimestamp()
    });
    toast("Diary saved");
    refreshPatientMetrics();
  };

  $("#save-med").onclick = async ()=>{
    if(!auth.currentUser) return;
    await addDoc(collection(db,"medLogs"),{
      uid: auth.currentUser.uid, name: $("#med-name").value.trim(),
      status: $("#med-status").value, when: $("#med-time").value, created: serverTimestamp()
    });
    toast("Medication logged");
    loadRecentMeds();
    refreshPatientMetrics();
  };

  $("#save-res").onclick = async ()=>{
    if(!auth.currentUser) return;
    await addDoc(collection(db,"resources"),{
      uid: auth.currentUser.uid, title: $("#res-title").value.trim(),
      url: $("#res-url").value.trim(), notes: $("#res-notes").value.trim(), created: serverTimestamp()
    });
    toast("Resource saved");
    $("#res-title").value=""; $("#res-url").value=""; $("#res-notes").value="";
  };

  $("#save-profile").onclick = async ()=>{
    if(!auth.currentUser) return;
    const profRef = doc(db,"users",auth.currentUser.uid);
    const role = $("#prof-role").value;
    const name = $("#prof-name").value.trim();
    await setDoc(profRef, { role, name, email: auth.currentUser.email }, { merge:true });
    toast("Profile saved");
    modeSwitch.checked = (role==="professional");
    applyMode(role);
  };

  // Metrics helpers
  async function countTodaysTics(uid){
    const now = new Date(), start = new Date(now.getFullYear(),now.getMonth(),now.getDate()), end = new Date(now.getFullYear(),now.getMonth(),now.getDate()+1);
    const qy = query(collection(db,"ticLogs"),
      where("uid","==",uid),
      where("created",">=",Timestamp.fromDate(start)),
      where("created","<",Timestamp.fromDate(end))
    );
    const snap = await getDocs(qy);
    return snap.size;
  }

  async function latestMood(uid){
    const qy = query(collection(db,"diary"), where("uid","==",uid), orderBy("created","desc"), limit(1));
    const snap = await getDocs(qy);
    if(snap.empty) return null;
    return snap.docs[0].data().mood;
  }

  async function adherence7d(uid){
    const now=new Date(), start=new Date(now.getFullYear(),now.getMonth(),now.getDate()-6);
    const qy = query(collection(db,"medLogs"),
      where("uid","==",uid),
      where("created",">=",Timestamp.fromDate(start))
    );
    const snap = await getDocs(qy);
    if(snap.empty) return null;
    let taken=0,total=0;
    snap.forEach(d=>{ total++; if(d.data().status==="taken") taken++; });
    return Math.round((taken/total)*100);
  }

  async function loadRecentMeds(){
    if(!auth.currentUser) return;
    const tbody = $("#meds-table tbody"); tbody.innerHTML="";
    const qy = query(collection(db,"medLogs"), where("uid","==",auth.currentUser.uid), orderBy("created","desc"), limit(10));
    const snap = await getDocs(qy);
    snap.forEach(d=>{
      const {name,status,created} = d.data();
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${created ? new Date(created.toDate()).toLocaleString() : ''}</td><td>${name||"â€”"}</td><td>${status}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function refreshPatientMetrics(){
    if(!auth.currentUser) return;
    const uid = auth.currentUser.uid;
    $("#metric-today").textContent = await countTodaysTics(uid);
    const mood = await latestMood(uid);
    $("#metric-mood").textContent = mood || "â€”";
    $("#metric-mood-sub").textContent = mood ? "Latest diary entry." : "Log a diary entry to update.";
    const adh = await adherence7d(uid);
    if(adh==null){ $("#metric-adherence").textContent="â€”"; $("#metric-adherence-sub").textContent="Log doses to see adherence."; }
    else { $("#metric-adherence").textContent= adh+"%"; $("#metric-adherence-sub").textContent="Last 7 days."; }
  }

  // --- Tic Logs LIST with delete + pagination ---
  const TICS_PAGE_SIZE = 20;
  let ticsCursor = null;
  let ticsFilter = "all";

  $("#tics-filter").onchange = ()=>{
    ticsFilter = $("#tics-filter").value;
    resetTicList(); loadTicPage();
  };
  $("#tics-load").onclick = ()=> loadTicPage(true);

  function resetTicList(){
    $("#tics-table tbody").innerHTML="";
    ticsCursor = null;
  }

  async function loadTicPage(isMore=false){
    if(!auth.currentUser) return;
    const uid = auth.currentUser.uid;
    const tbody = $("#tics-table tbody");
    let qyBase = query(collection(db,"ticLogs"), where("uid","==",uid), orderBy("created","desc"));
    if(ticsFilter==="today"){
      const now=new Date(), start=new Date(now.getFullYear(),now.getMonth(),now.getDate());
      qyBase = query(qyBase, where("created",">=",Timestamp.fromDate(start)));
    }

    let qy = query(qyBase, limit(TICS_PAGE_SIZE));
    if(isMore && ticsCursor){ qy = query(qyBase, startAfter(ticsCursor), limit(TICS_PAGE_SIZE)); }

    try{
      const snap = await getDocs(qy);
      if(!snap.empty){ ticsCursor = snap.docs[snap.docs.length-1]; }

      snap.forEach(d=>{
        const { type, intensity, duration, desc, addedBy, created } = d.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${created ? new Date(created.toDate()).toLocaleString() : ''}</td>
          <td>${type||''}</td>
          <td>${intensity ?? ''}</td>
          <td>${duration ?? ''}</td>
          <td>${(desc||'').replace(/</g,'&lt;')}</td>
          <td>${addedBy||''}</td>
          <td class="actions"><button class="btn secondary btn-del" data-id="${d.id}">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });

      // attach delete
      $$(".btn-del").forEach(btn=>{
        btn.onclick = async ()=>{
          try{
            await deleteDoc(doc(db,"ticLogs", btn.dataset.id));
            toast("Log deleted");
            resetTicList(); loadTicPage();
            refreshPatientMetrics();
          }catch(e){ toast("Delete failed: " + (e?.message||"")); }
        };
      });

      $("#tics-load").style.display = (snap.size < TICS_PAGE_SIZE) ? "none" : "inline-block";
    }catch(e){
      console.error(e);
      toast("This list needs a Firestore index. Check the console for a link.");
    }
  }

  // Professional view
  async function loadProView(){
    const tbody = $("#pro-table tbody"); tbody.innerHTML="";
    const patSnap = await getDocs(query(collection(db,"users"), where("role","==","patient")));
    $("#pro-active").textContent = patSnap.size;

    let adhSum=0, adhCount=0;

    for (const docu of patSnap.docs){
      const u = docu.data(); const uid = docu.id;
      const tics = await countTodaysTics(uid);
      const adh = await adherence7d(uid);
      if(adh!=null){ adhSum += adh; adhCount++; }
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${u.name || "(no name)"}<br><small>${u.email||""}</small></td><td>${tics}</td><td>${adh!=null? adh+"%":"â€”"}</td>`;
      tbody.appendChild(tr);
    }
    $("#pro-adherence").textContent = adhCount? Math.round(adhSum/adhCount)+"%":"â€”";
  }

  // Role / mode handling
  modeSwitch.onchange = ()=> applyMode(modeSwitch.checked ? "professional" : "patient");

  function applyMode(role){
    if(role==="professional"){
      navPatient.style.display="none"; navPro.style.display="block";
      welcome.textContent = "Welcome, Professional User!";
      showPage("pro-patients");
      modeSwitch.checked = true;
      loadProView();
    }else{
      navPatient.style.display="block"; navPro.style.display="none";
      welcome.textContent = "Welcome, Patient!";
      showPage("dash-patient");
      modeSwitch.checked = false;
      refreshPatientMetrics();
    }
  }

  function showPage(id){
    $$(".nav-link").forEach(x=>x.classList.remove("active"));
    $$(".page").forEach(p=>p.style.display="none");
    const el = document.getElementById(id); if(el) el.style.display="block";
    const nav = document.querySelector(`.nav-link[data-target="${id}"]`); if(nav) nav.classList.add("active");
  }

  // Auth state
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ modal.style.display="flex"; return; }
    modal.style.display="none";
    const profRef = doc(db,"users",user.uid);
    const snap = await getDoc(profRef);
    let role = "patient", name = "";
    if(!snap.exists()){
      await setDoc(profRef,{ email:user.email, role:"patient", name:"", created:serverTimestamp() });
    }else{
      role = snap.data().role || "patient";
      name = snap.data().name || "";
    }
    $("#prof-role").value = role;
    $("#prof-name").value = name;
    modeSwitch.checked = (role==="professional");
    applyMode(role);
  });

  function mapAuth(e){
    const m = {
      "auth/invalid-credential":"Wrong email or password.",
      "auth/wrong-password":"Wrong password.",
      "auth/user-not-found":"No account found for that email.",
      "auth/too-many-requests":"Too many attempts. Try later.",
      "auth/email-already-in-use":"That email is already registered.",
      "auth/invalid-email":"Enter a valid email.",
      "auth/weak-password":"Password must be at least 6 characters."
    };
    return m[e?.code] || e?.message || "Something went wrong.";
  }
</script>
</body>
</html>
